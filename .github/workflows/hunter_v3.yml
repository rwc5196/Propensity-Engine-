name: "Hunter Enrichment v3"

on:
  workflow_dispatch:
    inputs:
      limit:
        description: 'Number of companies to enrich'
        required: true
        default: '10'
        type: choice
        options:
          - '5'
          - '10'
          - '20'
          - '30'

jobs:
  hunter-enrichment:
    name: "Hunter.io Pattern Enrichment"
    runs-on: ubuntu-latest
    
    steps:
      - name: "Checkout"
        uses: actions/checkout@v4

      - name: "Setup Python"
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: "Install dependencies"
        run: pip install requests supabase

      - name: "Run Hunter Enrichment v3"
        env:
          HUNTER_API_KEY: ${{ secrets.HUNTER_API_KEY }}
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_KEY: ${{ secrets.SUPABASE_KEY }}
          LIMIT: ${{ inputs.limit }}
        run: |
          python << 'PYTHONEOF'
          import os
          import re
          import time
          import requests
          from datetime import datetime
          from supabase import create_client

          HUNTER_API_KEY = os.environ['HUNTER_API_KEY']
          supabase = create_client(os.environ['SUPABASE_URL'], os.environ['SUPABASE_KEY'])
          LIMIT = int(os.environ.get('LIMIT', '10'))

          PRIORITY_1 = ['procurement', 'purchasing', 'sourcing', 'vendor']
          PRIORITY_2 = ['plant manager', 'facility manager', 'site manager', 'warehouse manager']
          PRIORITY_3 = ['operations manager', 'operations director', 'production manager', 'manufacturing manager']
          PRIORITY_4 = ['hr director', 'human resources director', 'talent acquisition']

          EXCLUDE_TITLES = [
              'marketing', 'sales', 'account', 'business development',
              'finance', 'financial', 'accounting', 'controller',
              'legal', 'counsel', 'attorney', 'compliance',
              'communications', 'public relations', 'media', 'brand',
              'customer experience', 'customer success', 'customer service',
              'software', 'engineer', 'developer', 'architect', 'IT ',
              'data', 'analytics', 'scientist', 'research',
              'platform', 'product manager', 'product director',
              'consultant', 'advisory', 'intern', 'assistant', 'coordinator',
          ]

          def check_credits():
              try:
                  r = requests.get("https://api.hunter.io/v2/account", params={"api_key": HUNTER_API_KEY}, timeout=10)
                  return r.json().get('data', {}).get('requests', {}).get('searches', {}).get('available', 0)
              except:
                  return 0

          def validate_domain(website):
              """Extract and validate domain from website URL."""
              if not website:
                  return None
              
              domain = website.lower().strip()
              domain = domain.replace('https://', '').replace('http://', '').replace('www.', '')
              domain = domain.split('/')[0].split('?')[0]
              
              if '.' not in domain:
                  return None
              if re.match(r'^\d+\.\d+\.\d+\.\d+', domain):
                  return None
              
              invalid = ['facebook.com', 'linkedin.com', 'twitter.com', 'instagram.com', 'youtube.com', 
                        'google.com', 'amazon.com', 'indeed.com', 'glassdoor.com', 'yelp.com', 'bbb.org']
              if domain in invalid:
                  return None
              
              return domain

          def domain_search(domain):
              """Search Hunter.io for email pattern."""
              try:
                  r = requests.get(
                      "https://api.hunter.io/v2/domain-search",
                      params={"domain": domain, "api_key": HUNTER_API_KEY, "limit": 20},
                      timeout=30
                  )
                  
                  if r.status_code == 400:
                      return {"error": "Domain not found or invalid"}
                  if r.status_code == 401:
                      return {"error": "Invalid API key"}
                  if r.status_code == 429:
                      return {"error": "Rate limited"}
                  if r.status_code != 200:
                      return {"error": f"HTTP {r.status_code}"}
                  
                  data = r.json().get('data', {})
                  contacts = []
                  for e in data.get('emails', []):
                      if e.get('first_name') and e.get('last_name'):
                          contacts.append({
                              "name": f"{e['first_name']} {e['last_name']}",
                              "email": e.get('value'),
                              "position": e.get('position') or '',
                              "confidence": e.get('confidence', 0),
                              "phone": e.get('phone_number'),
                              "linkedin": e.get('linkedin'),
                          })
                  return {"success": True, "pattern": data.get('pattern'), "contacts": contacts}
              except requests.exceptions.Timeout:
                  return {"error": "Timeout"}
              except Exception as e:
                  return {"error": str(e)}

          def score_contact(position):
              if not position:
                  return 0
              pos_lower = position.lower()
              for exclude in EXCLUDE_TITLES:
                  if exclude.lower() in pos_lower:
                      return -1
              for kw in PRIORITY_1:
                  if kw in pos_lower:
                      return 100
              for kw in PRIORITY_2:
                  if kw in pos_lower:
                      return 90
              for kw in PRIORITY_3:
                  if kw in pos_lower:
                      return 80
              for kw in PRIORITY_4:
                  if kw in pos_lower:
                      return 70
              if 'manager' in pos_lower or 'director' in pos_lower:
                  return 40
              return 20

          def find_best_contact(contacts):
              if not contacts:
                  return None, 0
              scored = [(score_contact(c.get('position', '')), c) for c in contacts if score_contact(c.get('position', '')) > 0]
              if not scored:
                  return None, 0
              scored.sort(key=lambda x: (x[0], x[1].get('confidence', 0)), reverse=True)
              if scored[0][0] >= 40:
                  return scored[0][1], scored[0][0]
              return None, 0

          def get_companies_to_enrich(limit):
              """
              FIXED: Get companies in correct priority order.
              Key fix: Don't limit in Supabase query - get all, sort in Python, THEN limit.
              """
              try:
                  # Step 1: Get ALL hot leads with priority
                  sh = supabase.table('signal_history').select(
                      'company_id, priority_rank'
                  ).eq('score_tier', 'hot').order('priority_rank').limit(500).execute()
                  
                  if not sh.data:
                      print("No hot leads found in signal_history")
                      return []
                  
                  # Create priority lookup
                  priority_lookup = {s['company_id']: s['priority_rank'] for s in sh.data}
                  company_ids = list(priority_lookup.keys())
                  
                  print(f"Found {len(company_ids)} hot leads")
                  print(f"Top 5 priority IDs: {company_ids[:5]}")
                  
                  # Step 2: Get company details - NO LIMIT here!
                  cm = supabase.table('company_master').select(
                      'id, company_name, website'
                  ).in_('id', company_ids).not_.is_(
                      'website', 'null'
                  ).is_(
                      'hunter_email_pattern', 'null'
                  ).is_(
                      'hunter_lookup_date', 'null'
                  ).execute()  # NO LIMIT - get all matching companies
                  
                  print(f"Found {len(cm.data)} companies needing enrichment")
                  
                  if not cm.data:
                      return []
                  
                  # Step 3: Add priority rank and sort
                  results = []
                  for c in cm.data:
                      rank = priority_lookup.get(c['id'], 9999)
                      results.append({**c, 'priority_rank': rank})
                  
                  # Sort by priority (lowest rank = highest priority)
                  results.sort(key=lambda x: x['priority_rank'])
                  
                  # Step 4: NOW apply limit
                  final = results[:limit]
                  
                  print(f"Selected top {len(final)} companies:")
                  for i, c in enumerate(final[:5], 1):
                      print(f"  {i}. {c['company_name']} (rank {c['priority_rank']})")
                  
                  return final
                  
              except Exception as e:
                  print(f"Database error: {e}")
                  import traceback
                  traceback.print_exc()
                  return []

          def save_enrichment(company_id, pattern, contact, contact_score):
              try:
                  update = {'hunter_email_pattern': pattern, 'hunter_lookup_date': datetime.now().isoformat()}
                  if contact and contact_score >= 70:
                      update['primary_contact_name'] = contact.get('name')
                      if contact.get('position'):
                          update['primary_contact_title'] = contact['position']
                      if contact.get('email'):
                          update['primary_contact_email'] = contact['email']
                      if contact.get('phone'):
                          update['primary_contact_phone'] = contact['phone']
                      if contact.get('linkedin'):
                          update['primary_contact_linkedin'] = contact['linkedin']
                  supabase.table('company_master').update(update).eq('id', company_id).execute()
                  return True
              except Exception as e:
                  print(f"Save error: {e}")
                  return False

          def mark_failed(company_id, error):
              """Mark company as searched even if failed."""
              try:
                  supabase.table('company_master').update({
                      'hunter_lookup_date': datetime.now().isoformat(),
                  }).eq('id', company_id).execute()
              except:
                  pass

          # =============================================================
          # MAIN EXECUTION
          # =============================================================
          
          print("=" * 70)
          print("HUNTER.IO ENRICHMENT v3 - FIXED PRIORITY SELECTION")
          print("=" * 70)
          print("Key fix: Sort by priority BEFORE limiting results")
          print("=" * 70)

          credits = check_credits()
          print(f"\nðŸ’³ Credits available: {credits}")
          print(f"ðŸŽ¯ Requested limit: {LIMIT}")

          if credits == 0:
              print("âŒ No credits remaining!")
              exit(0)

          actual_limit = min(LIMIT, credits)
          print(f"ðŸ“‹ Will process: {actual_limit} companies\n")

          companies = get_companies_to_enrich(actual_limit)
          
          if not companies:
              print("âš ï¸ No companies found needing enrichment")
              exit(0)

          print(f"\n{'=' * 70}")
          print("PROCESSING")
          print("=" * 70)

          processed, patterns_found, good_contacts, errors = 0, 0, 0, 0

          for i, co in enumerate(companies, 1):
              company_id = co['id']
              name = co['company_name']
              website = co.get('website', '')
              rank = co.get('priority_rank', '?')

              domain = validate_domain(website)
              if not domain:
                  print(f"  {i}. {name} (rank {rank}) - âš ï¸ Invalid domain: {website}")
                  mark_failed(company_id, "Invalid domain")
                  continue

              print(f"  {i}. {name} (rank {rank}) - {domain}")
              
              result = domain_search(domain)
              processed += 1

              if result.get('success'):
                  pattern = result.get('pattern')
                  if pattern:
                      patterns_found += 1
                      best_contact, score = find_best_contact(result.get('contacts', []))
                      if best_contact and score >= 70:
                          tier = "T1" if score >= 90 else "T2"
                          print(f"      âœ… Pattern: {pattern} | {tier}: {best_contact['name']}")
                          good_contacts += 1
                      else:
                          print(f"      âœ… Pattern: {pattern} | No relevant contact")
                      save_enrichment(company_id, pattern, best_contact, score)
                  else:
                      print(f"      âš ï¸ No pattern found")
                      mark_failed(company_id, "No pattern")
              else:
                  error = result.get('error', 'Unknown')
                  print(f"      âŒ Error: {error}")
                  mark_failed(company_id, error)
                  errors += 1

              time.sleep(1.5)  # Rate limiting

          print(f"\n{'=' * 70}")
          print("SUMMARY")
          print("=" * 70)
          print(f"  Processed: {processed}")
          print(f"  Patterns found: {patterns_found}")
          print(f"  Good contacts (T1/T2): {good_contacts}")
          print(f"  Errors: {errors}")
          print(f"  Credits remaining: {check_credits()}")
          PYTHONEOF

      - name: "Write Summary"
        run: |
          echo "## Hunter.io Enrichment v3 Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Key Fix:** Priority selection now works correctly" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Next Step:** Run X-Ray v3 to find contacts" >> $GITHUB_STEP_SUMMARY
