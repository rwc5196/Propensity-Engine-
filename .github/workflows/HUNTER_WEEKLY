name: "Weekly Hunter Enrichment"

# Runs every Monday at 7 AM Central (13:00 UTC)
# Uses ~12 credits per run (50/month Ã· 4 weeks)

on:
  schedule:
    - cron: '0 13 * * 1'  # Monday 7 AM Central
  workflow_dispatch:  # Manual trigger

jobs:
  hunter-enrichment:
    name: "Hunter.io Contact Enrichment"
    runs-on: ubuntu-latest
    
    steps:
      - name: "Checkout"
        uses: actions/checkout@v4

      - name: "Setup Python"
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: "Install dependencies"
        run: pip install requests supabase

      - name: "Run Hunter Enrichment"
        env:
          HUNTER_API_KEY: ${{ secrets.HUNTER_API_KEY }}
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_KEY: ${{ secrets.SUPABASE_KEY }}
        run: |
          python << 'PYTHONEOF'
          import os
          import time
          import requests
          from datetime import datetime
          from supabase import create_client

          HUNTER_API_KEY = os.environ['HUNTER_API_KEY']
          supabase = create_client(os.environ['SUPABASE_URL'], os.environ['SUPABASE_KEY'])

          WEEKLY_BUDGET = 12  # 50 credits/month Ã· 4 weeks = 12/week

          def check_credits():
              """Check remaining Hunter credits."""
              r = requests.get(
                  "https://api.hunter.io/v2/account",
                  params={"api_key": HUNTER_API_KEY}
              )
              data = r.json().get('data', {})
              return data.get('requests', {}).get('searches', {}).get('available', 0)

          def domain_search(domain):
              """Search domain for email pattern and contacts."""
              r = requests.get(
                  "https://api.hunter.io/v2/domain-search",
                  params={"domain": domain, "api_key": HUNTER_API_KEY, "limit": 10},
                  timeout=15
              )
              if r.status_code != 200:
                  return None
              
              data = r.json().get('data', {})
              contacts = []
              for e in data.get('emails', []):
                  if e.get('first_name') and e.get('last_name'):
                      contacts.append({
                          "name": f"{e['first_name']} {e['last_name']}",
                          "email": e.get('value'),
                          "position": e.get('position'),
                          "confidence": e.get('confidence'),
                          "phone": e.get('phone_number'),
                          "linkedin": e.get('linkedin'),
                      })
              
              return {
                  "pattern": data.get('pattern'),
                  "organization": data.get('organization'),
                  "contacts": contacts,
              }

          def get_companies_to_enrich(limit):
              """Get hot leads needing enrichment."""
              # Get hot leads ordered by priority
              sh = supabase.table('signal_history').select(
                  'company_id, priority_rank'
              ).eq('score_tier', 'hot').order('priority_rank').limit(200).execute()
              
              company_ids = [s['company_id'] for s in sh.data]
              
              # Get companies with website but no Hunter pattern
              cm = supabase.table('company_master').select(
                  'id, company_name, website'
              ).in_('id', company_ids).not_.is_('website', 'null').is_(
                  'hunter_email_pattern', 'null'
              ).limit(limit).execute()
              
              # Sort by priority
              priority_lookup = {s['company_id']: s['priority_rank'] for s in sh.data}
              results = [{**c, 'rank': priority_lookup.get(c['id'], 999)} for c in cm.data]
              return sorted(results, key=lambda x: x['rank'])

          def extract_domain(website):
              """Extract domain from URL."""
              if not website:
                  return None
              d = website.lower().replace('https://', '').replace('http://', '').replace('www.', '')
              return d.split('/')[0] if '.' in d else None

          def save_enrichment(company_name, data):
              """Save Hunter results to database."""
              update = {
                  'hunter_email_pattern': data.get('pattern'),
                  'hunter_lookup_date': datetime.now().isoformat(),
              }
              
              # Find best contact (prefer operations/management roles)
              target_roles = ['operations', 'plant', 'facility', 'procurement', 'hr', 'manager', 'director']
              best_contact = None
              
              for contact in data.get('contacts', []):
                  pos = (contact.get('position') or '').lower()
                  if any(role in pos for role in target_roles):
                      best_contact = contact
                      break
                  elif not best_contact and contact.get('confidence', 0) >= 70:
                      best_contact = contact
              
              if best_contact:
                  update['primary_contact_name'] = best_contact['name']
                  if best_contact.get('position'):
                      update['primary_contact_title'] = best_contact['position']
                  if best_contact.get('email'):
                      update['primary_contact_email'] = best_contact['email']
                  if best_contact.get('phone'):
                      update['primary_contact_phone'] = best_contact['phone']
                  if best_contact.get('linkedin'):
                      update['primary_contact_linkedin'] = best_contact['linkedin']
              
              supabase.table('company_master').update(update).ilike(
                  'company_name', f"%{company_name}%"
              ).execute()

          # Main execution
          print("="*60)
          print("HUNTER.IO WEEKLY ENRICHMENT")
          print("="*60)

          credits = check_credits()
          print(f"\nðŸ’³ Credits available: {credits}")
          print(f"ðŸŽ¯ Weekly budget: {WEEKLY_BUDGET}")

          if credits < WEEKLY_BUDGET:
              print(f"âš ï¸  Only {credits} credits available, adjusting...")
              WEEKLY_BUDGET = credits

          if WEEKLY_BUDGET == 0:
              print("âŒ No credits remaining")
              exit(0)

          companies = get_companies_to_enrich(WEEKLY_BUDGET)
          print(f"ðŸ“‹ Found {len(companies)} companies to enrich\n")

          success = 0
          contacts_found = 0

          for i, co in enumerate(companies, 1):
              name = co['company_name']
              domain = extract_domain(co.get('website', ''))
              
              if not domain:
                  print(f"  {i}. {name} - âš ï¸ No domain")
                  continue
              
              print(f"  {i}. {name} ({domain})")
              
              result = domain_search(domain)
              
              if result:
                  pattern = result.get('pattern', '?')
                  num_contacts = len(result.get('contacts', []))
                  print(f"      âœ“ Pattern: {pattern} | Contacts: {num_contacts}")
                  
                  save_enrichment(name, result)
                  print(f"      âœ“ Saved to database")
                  
                  success += 1
                  contacts_found += num_contacts
              else:
                  print(f"      âœ— No data found")
              
              time.sleep(1)  # Rate limiting

          # Summary
          print(f"\n{'='*60}")
          print("SUMMARY")
          print("="*60)
          print(f"  Companies processed: {len(companies)}")
          print(f"  Successful: {success}")
          print(f"  Contacts found: {contacts_found}")
          
          remaining = check_credits()
          print(f"  Credits remaining: {remaining}")
          PYTHONEOF

      - name: "Write summary"
        run: |
          echo "## Hunter.io Enrichment Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Weekly enrichment job completed. Check logs for details." >> $GITHUB_STEP_SUMMARY
